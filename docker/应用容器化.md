# 应用的容器化

容器化（Containerizing）：将应用整合到容器中并且运行起来的过程称为“容器化”。也称为Docker化。



## Dockerfile

在Docker当中，包含应用文件的目录通常被称为构建上下文，通常将Dockerfile放到构建上下文的根目录下。

注意文件名严格区分大小写，必须是大写D开头的，名称为Dockerfile。

Dockerfile文件的作用：

- 包含了对当前应用的描述
- 指导Docker完成应用的容器化（创建一个包含当前应用的镜像）

简单的Dockerfile文件内容示例：

```dockerfile
# Test web-app to use with Pluralsight courses and Docker Deep Dive book
# Linux x64
FROM alpine

LABEL maintainer="nigelpoulton@hotmail.com"

# Install Node and NPM
RUN apk add --update nodejs nodejs-npm

# Copy app to /src
COPY . /src

WORKDIR /src

# Install dependencies
RUN  npm install

EXPOSE 8080

ENTRYPOINT ["node", "./app.js"]
```

### FROM

FROM指令位于Dockerfile文件中的第一行。

FROM指令指定的镜像，会作为当前镜像的一个基础镜像层，当前应用的剩余内容，将会作为新增镜像层添加到基础镜像层之上。

### LABEL

LABEL标签主要用来进行额外的说明描述，它其实是一个键值对，在一个镜像当中可以通过增加标签的方式来为镜像添加自定义元数据。

### RUN

RUN指令会在FROM指定的alpine基础镜像之上，新建一个镜像层来存储这些安装内容。

### COPY

COPY指令将应用相关文件从构建上下文复制到当前镜像中，并且新建一个镜像层来存储。

### WORKDIR

WORKDIR指令为Dockerfile中尚未执行的指令设置工作目录。该目录与镜像相关，并且会作为元数据记录到镜像配置中，但不会创建新的镜像层。

### ENTRYPOINT

ENTRYPOINT指令指定当前镜像的入口程序，ENTRYPOINT指定的配置信息也是通过镜像元数据的形式保存下来，而不是新增镜像层。



## 构建镜像

通常在Dockerfile文件所在的目录中，执行`docker image build`命令来构建镜像。

```shell
$ docker image build -t web:latest .
```

上述命令会构建并生成一个名为web:latest的镜像，注意：命令最后的点（.）表示Docker在进行构建的时候，使用当前目录作为构建上下文。

命令执行结束后，可以通过`docker image ls`命令来查看本地Docker镜像库是否包含了刚才构建的镜像。

也可以通过`docker image inspect`命令来查看构建的镜像的配置是否正确。



## 推送镜像

`docker image push`命令默认的推送的公共镜像仓库服务地址是Docker Hub。

### 第一步：登录Docker Hub

执行docker login命令，输入用户名和密码。

```shell
$ docker login
```

### 第二步：为镜像打标签

Docker在镜像推送的过程中需要如下信息，因此需要先设定再执行推送。需要的信息有：

- Registry（镜像仓库服务）：默认为docker.io。
- Repository（镜像仓库）：需要显式指定，从被推送镜像中的REPOSITORY属性值获取。
- Tag（镜像标签）：默认为latest。

为镜像打标签命令格式：

```
docker image tag <current-tag> <new-tag>
```

该命令的作用是为指定的镜像添加一个额外的标签，并且不需要覆盖已经存在的标签。

示例：

```shell
$ docker image tag web:latest smallz/web:latest
```

### 第三步：推送到Docker Hub

```shell
$ docker image push smallz/web:latest
```

确定镜像所要推送的目的仓库：<span style="color:blue">docker.io</span>/<span style="color:red;">smallz/web</span>:<span style="color:blue">latest</span>，其中蓝色字体为默认值，而红色字体的内容可以通过`docker image ls`命令进行查看。



## 运行镜像和容器

使用`docker container run`命令启动容器。